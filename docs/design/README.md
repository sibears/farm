# Архитектура  <!-- omit in toc -->

- [Контекст системы](#контекст-системы)
- [Компоненты системы](#компоненты-системы)
  - [Flag flow](#flag-flow)
- [Сервисы](#сервисы)
  - [Mono-backend](#mono-backend)
  - [Flag-sender](#flag-sender)

> Фиолетовый - рассматриваемая система  
> Белый - внешние компоненты  
> Жёлтый - внешние компоненты, реализующие часть логики системы

## Контекст системы

Ферма - сервис команды для автоматизированной и централизованной отправки флагов.  
Агрегирует в себе информацию о том куда и как сдавать, какой формат флага и историю сдачи флагов.  

![context](./img/context.drawio.svg)

Непосредственные пользователи системы - игроки. Их потребности:
- смотреть какие и сколько флагов сдано
- смотреть какие сплоиты приносят сколько флагов
- менять конфигурацию атак (например, состав противников)
- менять конфигурацию сдачи (например, лимиты сдачи флагов, токены доступа)

Клиентами фермы являются сплоиты, ворующие флаги. Для их работы требуется:
1. как минимум:
   - список и адреса противников
   - формат флага
2. опционально (реализуется за счёт внешнего сервиса):
   - атак дата
   - кэш кредов

Для целей мониторинга и наблюдаемости, сервисы по типу Prometheus, могут ходить за:
1. Бизнес метриками:
   - количество сданных флагов
   - количество <статус> флагов
   - количество флагов по сервисами
   - длина очереди
   - время ожидания сдачи флагов
   - время обработка флагов
   - ...
2. Технические метрики:
   - RPS
   - размер базы данных
   - ...

## Компоненты системы

![container](./img/containers.drawio.svg)

Общение между системами реализуется с помощью REST и gRPC API.  
Спецификация REST описывается с помощью [OpenAPI/Swagger](https://www.openapis.org/), а gRPC самодостаточен.

Все основные обязанности содержит `mono-backend`:
- раздаёт и управляет конфигом
- принимает и отдаёт флаги
- управляет сдачей флагов посредством управления очередью 
- агрегирует метрики

Монолитность `mono-backend` выбрана из-за удобной реализации управления сдачи флагов, благодаря которой достигается консистентность флагов и очередей.
При этом ни один компонент системы не завязан на синхронизации через базу данных.
В будущем, при надобности, можно распилить монолит.

На диаграмме `flag-sender`'ов несколько, так как их количество можно скалировать для лучшей сдачи флагов.  
Сдача флагов выделены из `mono-backend` из-за:
1. Отправка флагов может быть реализована на разных языках - зависит от языка протокола для используемой журейки
2. Сдача флагов напрямую зависит от стабильности журейки
3. Удобно скалировать

`flag-sender` узнает о новых флагах по оповещению от `mono-backend`. Оповещение реализуется за счёт [long polling](https://en.wikipedia.org/wiki/Push_technology#Long_polling)'a (самый простой вариант) и [gRPC streaming](https://grpc.io/docs/languages/go/basics/#server-side-streaming-rpc).

### Flag flow
1. Start_sploit.py прислал флаг
2. Mono-backend положил в базу данных и поставил в очередь на сдачу
3. Mono-backend отдаёт флаг свободному `flag-sender`'а и перемещает флаг в очередь ожидания вердикта
4. Если срабатывает таймаут сдачи флага, то mono-backend считает, что `flag-sender` упал/завис, а флаг перемещает обратно в очередь на сдачу
5. Mono-backend получил от `flag-sender`'а вердикт, удалил флаг из очередей и обновил информацию о флагах

## Сервисы

### Mono-backend

![Backend](./img/mono-backend.drawio.svg)

### Flag-sender

![Flag-sender](./img/flag-sender.drawio.svg)
